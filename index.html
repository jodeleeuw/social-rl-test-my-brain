<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-html-slider-response.js"></script>
    <link rel="stylesheet" href="jspsych/css/jspsych.css">
    <style>
      img.cue {
        cursor: pointer;
        border: 0px solid #aaa;
        border-radius: 10px;
        padding: 15px;
        margin: 0px;
        box-shadow: 0px 0px 5px 2px #ddd;
      }

      img.mini {
        transform: scale(0.8)
      }

      #jspsych-html-button-response-btngroup {
        width: 280px;
        margin: auto;
      }

      img.feedback {
        width: 190px;
      }

      img.gs {
        filter: grayscale(100%);
      }

      div.instructions {
        max-width: 800px;
      }

      @media only screen and (max-width: 600px) {
        div.instructions {
          font-size: 12px;
          line-height: 1.5em;
        }
      }
    </style>
  </head>
  <body>

  </body>
  <script>

    var timeline = [];

    var instructions = {
      timeline: [{
        type: 'html-button-response',
        stimulus: '<div class="instructions">'+
          '<p>You will be presented with two pictures on the screen and you have to choose one of them by clicking on it.</p>'+
          '<p>During the task, one of the pictures will be followed by a reward (thumbs up) more often than the other one and this will change as the game goes on. You have to pick the picture that you think is giving you reward at that time and your objective is to get as many thumbs-up (rewards) and as little thumbs-down (punishments) as you can. The pictures will be on the screen only for a short while and you have to make your responses within this time.</p>',
          choices: ['Continue']
      },
      {
        type: 'html-button-response',
        stimulus: '<div class="instructions">'+
          '<p>At the beginning and end of each block, you will be asked to rate few affective rating questionnaires. I will show you how to do these during the practice block.</p>'+
          '<p>I will give you a practice now with example pictures. For the practice round, there will be no associations between the pictures and the reward or punishment. The goal of the practice is to get you acquainted the type of stimuli that you will be seeing and the general format of the game.</p>',
        choices: ['Continue']
      }],
      data: {task: 'instructions'}
    }

    timeline.push(instructions);

    var affective_ratings = [
      {
        type: 'html-slider-response',
        stimulus: '<p>How are you currently feeling?</p>',
        labels: ["Hostile", "Neutral", "Friendly"],
        slider_width: 250,
        data: {question: 'Hostile-Friendly'}
      },
      {
        type: 'html-slider-response',
        stimulus: '<p>How are you currently feeling?</p>',
        labels: ["Sad", "Neutral", "Happy"],
        slider_width: 250,
        data: {question: 'Sad-Happy'}
      },
      {
        type: 'html-slider-response',
        stimulus: '<p>How are you currently feeling?</p>',
        labels: ["Tensed", "Neutral", "Relaxed"],
        slider_width: 250,
        data: {question: 'Tensed-Relaxed'}
      },
      {
        type: 'html-slider-response',
        stimulus: '<p>How are you currently feeling?</p>',
        labels: ["Withdrawn", "Neutral", "Social"],
        slider_width: 250,
        data: {question: 'Withdrawn-Social'}
      },
    ]

    var fixation_trial = {
      type: 'html-keyboard-response',
      stimulus: '<p style="font-size:48px;">+</p>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000
    }

    var clicked;
    var cue_trial = {
      type: 'html-button-response',
      choices: ['img/Stim_set1_1.png', 'img/Stim_set1_2.png'],
      stimulus: '',//'<p>Select a picture.</p>',
      button_html: '<img class="cue" src="%choice%"></img>',
      post_trial_gap: 1000,
      margin_vertical: "20px",
      margin_horizontal: "0px",
      response_ends_trial: false,
      trial_duration: 1500,
      data: {
        rewarding_choice: jsPsych.timelineVariable('rewarding_choice'),
        task: 'rl-select'
      },
      on_load: function(){
        clicked = false;
        var img_btns = jsPsych.getDisplayElement().querySelectorAll('img');
        for(var i=0; i<img_btns.length; i++){
          img_btns[i].addEventListener('click', function(e){
            if(!clicked){
              e.target.style.filter = 'grayscale(100%)';
              clicked = true;
            }
          });
        }
      },
      on_finish: function(data){
        if(data.button_pressed !== null){
          data.rewarded = data.button_pressed == data.rewarding_choice;
        } else {
          data.rewarded = null;
        }
      }
    }

    var feedback_trial = {
      type: 'html-keyboard-response',
      stimulus: function(){
        var reward = jsPsych.data.get().last(1).values()[0].rewarded
        if(reward == null){
          return "<p>Please respond faster.</p>"
        }
        if(reward == true){
          return "<img src='img/thumbs_up.png' class='feedback'></img>";
        }
        if(reward == false){
          return "<img src='img/thumbs_down.png' class='feedback'></img>";
        }
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 1500,
    }

    var practice_block = {
      timeline: [fixation_trial, cue_trial, feedback_trial],
      timeline_variables: [
        {rewarding_choice: 0},
        {rewarding_choice: 1}
      ],
      data: {block: 'practice'},
      sample: {
        type: 'custom',
        fn: function(){
          var total_trials = 10;
          var p_reward_0 = 0.5;
          var sample = jsPsych.randomization.shuffle(Array(total_trials).fill(0, 0, total_trials*p_reward_0).fill(1, total_trials*p_reward_0));
          return sample;
        }
      }
    }
    timeline.push(practice_block);

    var ar_start = {
      timeline: affective_ratings,
      data: {
        task: 'affective_ratings',
        phase: 'start'
      }
    }
    timeline.push(ar_start);

    var block_1 = {
      timeline: [fixation_trial, cue_trial, feedback_trial],
      timeline_variables: [
        {rewarding_choice: 0},
        {rewarding_choice: 1}
      ],
      data: {block: 1},
      sample: {
        type: 'custom',
        fn: function(){
          var total_trials = 20;
          var p_reward_0 = 0.8;
          var sample = jsPsych.randomization.shuffle(Array(total_trials).fill(0, 0, total_trials*p_reward_0).fill(1, total_trials*p_reward_0));
          return sample;
        }
      }
    }

    timeline.push(block_1);

    var block_2 = {
      timeline: [fixation_trial, cue_trial, feedback_trial],
      timeline_variables: [
        {rewarding_choice: 0},
        {rewarding_choice: 1}
      ],
      data: {block: 2},
      sample: {
        type: 'custom',
        fn: function(){
          var total_trials = 20;
          var p_reward_0 = 0.1;
          var sample = jsPsych.randomization.shuffle(Array(total_trials).fill(0, 0, total_trials*p_reward_0).fill(1, total_trials*p_reward_0));
          return sample;
        }
      }
    }

    //timeline.push(block_2);

    var block_3 = {
      timeline: [fixation_trial, cue_trial, feedback_trial],
      timeline_variables: [
        {rewarding_choice: 0},
        {rewarding_choice: 1}
      ],
      data: {block: 3},
      sample: {
        type: 'custom',
        fn: function(){
          var total_trials = 20;
          var p_reward_0 = 0.5;
          var sample = jsPsych.randomization.shuffle(Array(total_trials).fill(0, 0, total_trials*p_reward_0).fill(1, total_trials*p_reward_0));
          return sample;
        }
      }
    }

    //timeline.push(block_3);

    var block_4 = {
      timeline: [fixation_trial, cue_trial, feedback_trial],
      timeline_variables: [
        {rewarding_choice: 0},
        {rewarding_choice: 1}
      ],
      data: {block: 4},
      sample: {
        type: 'custom',
        fn: function(){
          var total_trials = 20;
          var p_reward_0 = 0.8;
          var sample = jsPsych.randomization.shuffle(Array(total_trials).fill(0, 0, total_trials*p_reward_0).fill(1, total_trials*p_reward_0));
          return sample;
        }
      }
    }

    //timeline.push(block_4);

    var picture_select_task = {
      type: 'html-button-response',
      choices: ['img/Stim_set1_1.png', 'img/Stim_set1_2.png'],
      stimulus: function(){
        return '<p>During the '+jsPsych.timelineVariable('phase', true)+' of the task, which picture gave you more thumbs up?</p>'
      },
      button_html: '<img class="cue" src="%choice%"></img>',
      post_trial_gap: 1000,
      margin_vertical: "20px",
      margin_horizontal: "0px",
      data: {
        question: 'picture-select',
        phase: jsPsych.timelineVariable('phase')
      }
    }

    var picture_confidence_task = {
      type: 'html-slider-response',
      stimulus: function(){
        var which_image = jsPsych.data.get().last(1).values()[0].button_pressed;
        var stim = '<div>'+
        '<p>How certain are you?</p>'
        if(which_image == 1){
          stim += '<img src="img/Stim_set1_1.png" class="cue mini"></img>'+
            '<img src="img/Stim_set1_2.png" class="cue mini gs"></img>'
        }
        if(which_image == 0){
          stim += '<img src="img/Stim_set1_2.png" class="cue mini"></img>'+
            '<img src="img/Stim_set1_1.png" class="cue mini gs"></img>'
        }
        stim += '</div>'
        return stim;
      },
      prompt: '',
      labels: ["0%", "100%"],
      slider_width: 250,
      post_trial_gap: 1000,
      data: {
        question: 'picture-confidence',
        phase: jsPsych.timelineVariable('phase')
      }
    }

    var picture_rating_procedure = {
      timeline: [picture_select_task, picture_confidence_task],
      timeline_variables: [
        {phase: 'START'},
        {phase: 'MIDDLE'},
        {phase: 'END'}
      ],
      data: {
        task: 'picture-rating'
      }
    }

    timeline.push(picture_rating_procedure);

    var post_survey = {
      timeline:[
        {
          type: 'html-slider-response',
          stimulus: '<p>Please rate how you felt after receiving the thumbs up.</p>',
          labels: ["Negative", "Neutral", "Positive"],
          slider_width: 250,
          data: {question: 'feeling-valence-reward'}
        },
        {
          type: 'html-slider-response',
          stimulus: '<p>Please rate the intensity of this feeling.</p>',
          labels: ["Low", "Mid", "High"],
          slider_width: 250,
          data: {question: 'feeling-intensity-reward'}
        },
        {
          type: 'html-slider-response',
          stimulus: '<p>Please rate how you felt after receiving the thumbs down.</p>',
          labels: ["Negative", "Neutral", "Positive"],
          slider_width: 250,
          data: {question: 'feeling-valence-punishment'}
        },
        {
          type: 'html-slider-response',
          stimulus: '<p>Please rate the intensity of this feeling.</p>',
          labels: ["Low", "Mid", "High"],
          slider_width: 250,
          data: {question: 'feeling-intensity-punishment'}
        },
        {
          type: 'html-slider-response',
          stimulus: '<p>How well did you think you performed during the game? (How many thumbs up did you get?)</p>',
          labels: ["None", "All the time"],
          slider_width: 250,
          data: {question: 'performance'}
        },
      ],
      data: {
        task: 'post-survey'
      }
    }

    timeline.push(post_survey);

    var ar_end = {
      timeline: affective_ratings,
      data: {
        task: 'affective_ratings',
        phase: 'end'
      }
    }
    timeline.push(ar_end);

    jsPsych.init({
      timeline: timeline,
      preload_images: ['img/Stim_set1_1.png', 'img/Stim_set1_2.png', 'img/Stim_set2_1.png', 'img/Stim_set2_2.png', 'img/Stim_set3_1.png', 'img/Stim_set3_2.png']
    })
  </script>
</html>